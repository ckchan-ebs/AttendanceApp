<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance Check-In</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      padding: 20px;
      text-align: center;
    }
    h2 {
      color: #333;
      font-size: 24px;
    }
    .container {
      margin-top: 30px;
    }
    #datetime {
      font-size: 18px;
      margin-bottom: 20px;
      color: #555;
    }
    #staffNameDisplay {
      font-size: 20px;
      margin-bottom: 30px;
      color: #333;
    }
    button {
      padding: 12px 24px;
      font-size: 18px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    table {
      width: 100%;
      max-width: 800px;
      margin: auto;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
    }
    th {
      background-color: #f2f2f2;
    }
    select {
      padding: 6px;
      margin: 10px;
      font-size: 16px;
    }
    @media (max-width: 600px) {
      button, select {
        width: 100%;
        font-size: 16px;
      }
      #staffNameDisplay {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <h2>Attendance Check-In</h2>
  <div id="datetime"></div>
  <div id="staffNameDisplay"></div>

  <div class="container">
    <button onclick="checkLocation()">Check In / Check Out</button>

    <h3>📜 Attendance History</h3>
    <div>
      <label>Month:</label>
      <select id="monthSelect" onchange="loadHistoryFromSheet()"></select>
      <label>Year:</label>
      <select id="yearSelect" onchange="loadHistoryFromSheet()"></select>
    </div>

    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Name</th>
          <th>Check-In</th>
          <th>Check-Out</th>
          <th>Total Hours</th>
          <th>Minutes</th>
          <th>Remark</th>
          <th>Location</th>
        </tr>
      </thead>
      <tbody id="historyBody">
        <!-- Attendance records will be inserted here -->
      </tbody>
    </table>
  </div>

  <script>
    // Constants for office location and max allowed distance (meters)
    const officeLat = 3.1925444;
    const officeLng = 101.6110718;
    const maxDistanceMeters = 500;

    // Display date and time updated every second, fixed to Kuala Lumpur timezone
    function updateDateTime() {
      const now = new Date();
      const optionsDate = { 
        timeZone: 'Asia/Kuala_Lumpur',
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
      };
      const optionsTime = { 
        timeZone: 'Asia/Kuala_Lumpur',
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
      };

      const dateStr = now.toLocaleDateString(undefined, optionsDate);
      const timeStr = now.toLocaleTimeString(undefined, optionsTime);

      document.getElementById("datetime").innerHTML = `${dateStr} | ${timeStr}`;
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    // Display stored staff name or default message
    const staffNameDisplay = document.getElementById("staffNameDisplay");
    const storedName = localStorage.getItem("staffName");
    staffNameDisplay.textContent = storedName ? `👤 ${storedName}` : '👤 No name saved yet';

    // Calculate distance between two GPS points using Haversine formula
    function distanceBetween(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // Earth radius in meters
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Geolocation check and proceed based on distance from office
    function checkLocation() {
      if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser.");
        proceedCheck("No GPS", "No Location");
        return;
      }

      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        const distance = distanceBetween(latitude, longitude, officeLat, officeLng);
        if (distance <= maxDistanceMeters) {
          proceedCheck("Used GPS", `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`);
        } else {
          if (confirm("❌ You are not in office area!\n\nProceed anyway?")) {
            proceedCheck("No GPS", "No Location");
          }
        }
      }, err => {
        if (err.code === 1) { // permission denied
          alert("Permission denied for location access.");
        }
        if (confirm("❌ Cannot get location. Proceed anyway?")) {
          proceedCheck("No GPS", "No Location");
        }
      }, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      });
    }

    // Handle Check-In or Check-Out logic
    function proceedCheck(remark, location) {
      let name = localStorage.getItem("staffName") || "";
      if (!name.trim()) {
        name = prompt("Enter your name:").trim();
        if (!name) return;  // Cancel if empty
        localStorage.setItem("staffName", name);
      }
      staffNameDisplay.textContent = `👤 ${name}`;

      const now = new Date();
      const currentTime = now.toLocaleString('en-GB', {
        timeZone: 'Asia/Kuala_Lumpur',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });

      // Get date string YYYY-MM-DD for comparing check-in/out date only
      const todayDateStr = new Date(now.toLocaleDateString('en-CA', { timeZone: 'Asia/Kuala_Lumpur' })).toISOString().slice(0,10);

      const lastActionDate = localStorage.getItem("lastActionDate");

      // If last action was on same date, this is Check-Out, else Check-In
      const action = (lastActionDate === todayDateStr) ? "Check-Out" : "Check-In";

      if (action === "Check-In") {
        localStorage.setItem("lastActionDate", todayDateStr);
      } else {
        localStorage.removeItem("lastActionDate");
      }

      sendAttendance(name, action, remark, location, currentTime);

      // Reload attendance history shortly after sending
      setTimeout(loadHistoryFromSheet, 1000);
    }

    // Send attendance data to Google Form via POST
    function sendAttendance(name, action, remark, location, time) {
      const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSdGDioMohaZRkJrgxoseooVhyXTopysgEBE3QJB6cJMRzi2Wg/formResponse";
      const formData = new FormData();
      formData.append("entry.2140323296", name);
      formData.append("entry.668867521", action);
      formData.append("entry.1234567890", remark);
      formData.append("entry.9876543210", location);
      formData.append("entry.1234567891", time);

      fetch(formUrl, { method: "POST", mode: "no-cors", body: formData })
        .then(() => alert(`✅ ${action} successful for ${name} at ${time}`))
        .catch(() => alert("❌ Failed to send attendance!"));
    }

    // Load attendance history from Google Apps Script JSON endpoint
    function loadHistoryFromSheet() {
      const name = localStorage.getItem("staffName");
      if (!name) {
        alert("❗ Please check in at least once to save your name.");
        return;
      }

      const normName = name.trim().toLowerCase();

      const monthSelect = document.getElementById("monthSelect");
      const yearSelect = document.getElementById("yearSelect");
      const tbody = document.getElementById("historyBody");

      const selectedMonth = parseInt(monthSelect.value);
      const selectedYear = parseInt(yearSelect.value);

      const url = `https://script.google.com/macros/s/AKfycbxBjTno627hPi6F60Uzma_ba6DGxnYc6NEqGCjrr10IBr9-LxhhR_qimF8ay4CPEsRc/exec`;

      fetch(url)
        .then(resp => resp.json())
        .then(data => {
          const records = data.records || [];
          // Filter records by selected month, year and name
          const filtered = records.filter(r => {
            const dateStr = r.Date; // expect format like '2023-05-12'
            if (!dateStr) return false;

            const recordDate = new Date(dateStr);
            if (recordDate.getMonth() + 1 !== selectedMonth) return false;
            if (recordDate.getFullYear() !== selectedYear) return false;

            if (!r.Name) return false;
            return r.Name.trim().toLowerCase() === normName;
          });

          // Group by date and calculate Check-In, Check-Out and total hours
          const grouped = {};
          filtered.forEach(r => {
            const d = r.Date;
            if (!grouped[d]) grouped[d] = [];
            grouped[d].push(r);
          });

          tbody.innerHTML = "";
          Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a)).forEach(date => {
            const dayRecords = grouped[date];
            const checkInRec = dayRecords.find(r => r.Action.toLowerCase() === "check-in");
            const checkOutRec = dayRecords.find(r => r.Action.toLowerCase() === "check-out");

            const checkInTime = checkInRec ? checkInRec.Time : "";
            const checkOutTime = checkOutRec ? checkOutRec.Time : "";

            // Calculate total hours & minutes between check-in and check-out
            let totalHours = "", totalMinutes = "";
            if (checkInTime && checkOutTime) {
              const hmsToDate = (timeStr) => {
                const [h,m,s] = timeStr.split(":").map(Number);
                const d = new Date(0,0,0,h,m,s);
                return d;
              };
              const ciDate = hmsToDate(checkInTime);
              const coDate = hmsToDate(checkOutTime);
              let diffMs = coDate - ciDate;
              if(diffMs < 0) diffMs = 0; // no negative time
              const diffMinutes = Math.floor(diffMs / 60000);
              totalHours = Math.floor(diffMinutes / 60);
              totalMinutes = diffMinutes % 60;
            }

            // Remark and location (from Check-In record preferred)
            const remark = checkInRec ? checkInRec.Remark : "";
            const location = checkInRec ? checkInRec.Location : "";

            const row = `<tr>
              <td>${date}</td>
              <td>${name}</td>
              <td>${checkInTime}</td>
              <td>${checkOutTime}</td>
              <td>${totalHours}</td>
              <td>${totalMinutes}</td>
              <td>${remark}</td>
              <td>${location}</td>
            </tr>`;

            tbody.insertAdjacentHTML("beforeend", row);
          });

          if (tbody.children.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8">No records found for ${monthSelect.options[monthSelect.selectedIndex].text} ${selectedYear}</td></tr>`;
          }
        })
        .catch(err => {
          console.error(err);
          tbody.innerHTML = `<tr><td colspan="8">Error loading records.</td></tr>`;
        });
    }

    // Populate month and year dropdowns
    function populateMonthYearSelectors() {
      const monthSelect = document.getElementById("monthSelect");
      const yearSelect = document.getElementById("yearSelect");
      const now = new Date();

      // Month options (1 to 12)
      for(let m=1; m<=12; m++) {
        const option = document.createElement("option");
        option.value = m;
        option.text = new Date(0, m-1).toLocaleString('en', { month: 'long' });
        if (m === now.getMonth() + 1) option.selected = true;
        monthSelect.appendChild(option);
      }

      // Year options (5 years back and forward)
      const currentYear = now.getFullYear();
      for(let y=currentYear-5; y<=currentYear+5; y++) {
        const option = document.createElement("option");
        option.value = y;
        option.text = y;
        if (y === currentYear) option.selected = true;
        yearSelect.appendChild(option);
      }
    }

    populateMonthYearSelectors();
    loadHistoryFromSheet();

  </script>
</body>
</html>

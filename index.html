<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance Check-In</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      padding: 20px;
      text-align: center;
    }
    h2 {
      color: #333;
      font-size: 24px;
    }
    .container {
      margin-top: 30px;
    }
    #datetime {
      font-size: 18px;
      margin-bottom: 20px;
      color: #555;
    }
    #staffNameDisplay {
      font-size: 20px;
      margin-bottom: 30px;
      color: #333;
    }
    button {
      padding: 12px 24px;
      font-size: 18px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    table {
      width: 100%;
      max-width: 800px;
      margin: auto;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
    }
    th {
      background-color: #f2f2f2;
    }
    select {
      padding: 6px;
      margin: 10px;
      font-size: 16px;
    }
    @media (max-width: 600px) {
      button, select {
        width: 100%;
        font-size: 16px;
      }
      #staffNameDisplay {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <h2>Attendance Check-In</h2>
  <div id="datetime"></div>
  <div id="staffNameDisplay"></div>

  <div class="container">
    <button onclick="checkLocation()">Check In / Check Out</button>

    <h3>📜 Attendance History</h3>
    <div>
      <label>Month:</label>
      <select id="monthSelect" onchange="loadHistoryFromSheet()"></select>
      <label>Year:</label>
      <select id="yearSelect" onchange="loadHistoryFromSheet()"></select>
    </div>

    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Name</th>
          <th>Check-In</th>
          <th>Check-Out</th>
          <th>Total Hours</th>
          <th>Minutes</th>
          <th>Remark</th>
          <th>Location</th>
        </tr>
      </thead>
      <tbody id="historyBody">
        <!-- Attendance records will be inserted here -->
      </tbody>
    </table>
  </div>

  <script>
    // Constants for office location and max allowed distance (meters)
    const officeLat = 3.1925444;
    const officeLng = 101.6110718;
    const maxDistanceMeters = 500;

    // Display date and time updated every second, fixed to Kuala Lumpur timezone
    function updateDateTime() {
      const now = new Date();
      const optionsDate = { 
        timeZone: 'Asia/Kuala_Lumpur',
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
      };
      const optionsTime = { 
        timeZone: 'Asia/Kuala_Lumpur',
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
      };

      const dateStr = now.toLocaleDateString(undefined, optionsDate);
      const timeStr = now.toLocaleTimeString(undefined, optionsTime);

      document.getElementById("datetime").innerHTML = `${dateStr} | ${timeStr}`;
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    // Display stored staff name or default message
    const staffNameDisplay = document.getElementById("staffNameDisplay");
    const storedName = localStorage.getItem("staffName");
    staffNameDisplay.textContent = storedName ? `👤 ${storedName}` : '👤 No name saved yet';

    // Calculate distance between two GPS points using Haversine formula
    function distanceBetween(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // Earth radius in meters
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Geolocation check and proceed based on distance from office
    function checkLocation() {
      if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser.");
        proceedCheck("No GPS", "No Location");
        return;
      }

      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        const distance = distanceBetween(latitude, longitude, officeLat, officeLng);
        if (distance <= maxDistanceMeters) {
          proceedCheck("Used GPS", `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`);
        } else {
          if (confirm("❌ You are not in office area!\n\nProceed anyway?")) {
            proceedCheck("No GPS", "No Location");
          }
        }
      }, err => {
        if (err.code === 1) { // permission denied
          alert("Permission denied for location access.");
        }
        if (confirm("❌ Cannot get location. Proceed anyway?")) {
          proceedCheck("No GPS", "No Location");
        }
      }, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      });
    }

    // Handle Check-In or Check-Out logic
    function proceedCheck(remark, location) {
      let name = localStorage.getItem("staffName") || "";
      if (!name.trim()) {
        name = prompt("Enter your name:");
        if (!name) return;  // Cancel if empty
        name = name.trim();
        if (!name) return;  // Cancel if empty after trim
        localStorage.setItem("staffName", name);
      }
      staffNameDisplay.textContent = `👤 ${name}`;

      const now = new Date();
      const currentTime = now.toLocaleString('en-GB', {
        timeZone: 'Asia/Kuala_Lumpur',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });

      // Get date string YYYY-MM-DD for comparing check-in/out date only
      const todayDateStr = new Date(now.toLocaleDateString('en-CA', { timeZone: 'Asia/Kuala_Lumpur' })).toISOString().slice(0,10);

      const lastActionDate = localStorage.getItem("lastActionDate");

      // If last action was on same date, this is Check-Out, else Check-In
      const action = (lastActionDate === todayDateStr) ? "Check-Out" : "Check-In";

      if (action === "Check-In") {
        localStorage.setItem("lastActionDate", todayDateStr);
      } else {
        localStorage.removeItem("lastActionDate");
      }

      sendAttendance(name, action, remark, location, currentTime);

      // Reload attendance history shortly after sending
      setTimeout(loadHistoryFromSheet, 1000);
    }

    // Send attendance data to Google Form via POST
    function sendAttendance(name, action, remark, location, time) {
      const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSdGDioMohaZRkJrgxoseooVhyXTopysgEBE3QJB6cJMRzi2Wg/formResponse";
      const formData = new FormData();
      formData.append("entry.2140323296", name);
      formData.append("entry.668867521", action);
      formData.append("entry.1234567890", remark);
      formData.append("entry.9876543210", location);
      formData.append("entry.1234567891", time);

      fetch(formUrl, { method: "POST", mode: "no-cors", body: formData })
        .then(() => alert(`✔️ ${action} recorded at ${time}`))
        .catch(() => alert("❌ Failed to send attendance"));
    }

    // Populate month and year dropdowns for history filtering
    function populateMonthYearSelectors() {
      const monthSelect = document.getElementById("monthSelect");
      const yearSelect = document.getElementById("yearSelect");

      // Populate months Jan-Dec
      const monthNames = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];

      monthSelect.innerHTML = "";
      monthNames.forEach((month, idx) => {
        const option = document.createElement("option");
        option.value = idx + 1;
        option.textContent = month;
        monthSelect.appendChild(option);
      });

      // Populate last 5 years including current
      const currentYear = new Date().getFullYear();
      yearSelect.innerHTML = "";
      for(let y = currentYear; y >= currentYear - 5; y--) {
        const option = document.createElement("option");
        option.value = y;
        option.textContent = y;
        yearSelect.appendChild(option);
      }

      // Set defaults to current month/year
      monthSelect.value = new Date().getMonth() + 1;
      yearSelect.value = currentYear;
    }

    // Load and display attendance history filtered by selected month/year
    function loadHistoryFromSheet() {
      const month = document.getElementById("monthSelect").value;
      const year = document.getElementById("yearSelect").value;

      const sheetUrl = "https://script.google.com/macros/s/AKfycbyKY2m5VkRWW2O_NHlD3iDzLbq9GOiWeSLYPvIQMrjg5BZHo_qGVtrsKWzFJMsupJg4/exec";

      fetch(sheetUrl)
        .then(res => res.json())
        .then(data => {
          const records = data.records || [];
          const tbody = document.getElementById("historyBody");
          tbody.innerHTML = "";

          records.forEach(rec => {
            const recDate = new Date(rec.Date);
            if ((recDate.getMonth() + 1).toString() === month && recDate.getFullYear().toString() === year) {
              const tr = document.createElement("tr");

              tr.innerHTML = `
                <td>${rec.Date}</td>
                <td>${rec.Name}</td>
                <td>${rec["Check-In"] || ""}</td>
                <td>${rec["Check-Out"] || ""}</td>
                <td>${rec["TotalHours"] || ""}</td>
                <td>${rec["Minutes"] || ""}</td>
                <td>${rec.Remark}</td>
                <td>${rec.Location}</td>
              `;
              tbody.appendChild(tr);
            }
          });
        })
        .catch(() => {
          alert("Failed to load attendance history.");
        });
    }

    // Initialize selectors and load history on page load
    window.onload = () => {
      populateMonthYearSelectors();
      loadHistoryFromSheet();
    };
  </script>
</body>
</html>

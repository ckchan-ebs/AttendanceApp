<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance Check-In</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      padding: 20px;
      text-align: center;
    }
    h2 {
      color: #333;
      font-size: 24px;
    }
    .container {
      margin-top: 30px;
    }
    #datetime {
      font-size: 18px;
      margin-bottom: 20px;
      color: #555;
    }
    #staffNameDisplay {
      font-size: 20px;
      margin-bottom: 30px;
      color: #333;
    }
    button {
      padding: 12px 24px;
      font-size: 18px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    table {
      width: 100%;
      max-width: 800px;
      margin: auto;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
    }
    th {
      background-color: #f2f2f2;
    }
    select {
      padding: 6px;
      margin: 10px;
      font-size: 16px;
    }
    @media (max-width: 600px) {
      button, select {
        width: 100%;
        font-size: 16px;
      }
      #staffNameDisplay {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <h2>Attendance Check-In</h2>
  <div id="datetime"></div>
  <div id="staffNameDisplay"></div>

  <div class="container">
    <button onclick="checkLocation()">Check In / Check Out</button>

    <h3>📜 Attendance History</h3>
    <div>
      <label>Month:</label>
      <select id="monthSelect" onchange="loadHistoryFromSheet()"></select>
      <label>Year:</label>
      <select id="yearSelect" onchange="loadHistoryFromSheet()"></select>
    </div>

    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Name</th>
          <th>Check-In</th>
          <th>Check-Out</th>
          <th>Total Hours</th>
          <th>Minutes</th>
          <th>Remark</th>
          <th>Location</th>
        </tr>
      </thead>
      <tbody id="historyBody">
        <!-- Attendance records will be inserted here -->
      </tbody>
    </table>
  </div>

  <script>
    // Constants for office location and max allowed distance (meters)
    const officeLat = 3.1925444;
    const officeLng = 101.6110718;
    const maxDistanceMeters = 500;

    // Display date and time updated every second, fixed to Kuala Lumpur timezone
    function updateDateTime() {
      const now = new Date();
      const optionsDate = { 
        timeZone: 'Asia/Kuala_Lumpur',
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
      };
      const optionsTime = { 
        timeZone: 'Asia/Kuala_Lumpur',
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
      };

      const dateStr = now.toLocaleDateString(undefined, optionsDate);
      const timeStr = now.toLocaleTimeString(undefined, optionsTime);

      document.getElementById("datetime").innerHTML = `${dateStr} | ${timeStr}`;
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    // Display stored staff name or default message
    const staffNameDisplay = document.getElementById("staffNameDisplay");
    const storedName = localStorage.getItem("staffName");
    staffNameDisplay.textContent = storedName ? `👤 ${storedName}` : '👤 No name saved yet';

    // Calculate distance between two GPS points using Haversine formula
    function distanceBetween(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // Earth radius in meters
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Geolocation check and proceed based on distance from office
    function checkLocation() {
      if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser.");
        proceedCheck("No GPS", "No Location");
        return;
      }

      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        const distance = distanceBetween(latitude, longitude, officeLat, officeLng);
        if (distance <= maxDistanceMeters) {
          proceedCheck("Used GPS", `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`);
        } else {
          if (confirm("❌ You are not in office area!\n\nProceed anyway?")) {
            proceedCheck("No GPS", "No Location");
          }
        }
      }, err => {
        if (err.code === 1) { // permission denied
          alert("Permission denied for location access.");
        }
        if (confirm("❌ Cannot get location. Proceed anyway?")) {
          proceedCheck("No GPS", "No Location");
        }
      }, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      });
    }

    // Handle Check-In or Check-Out logic
    function proceedCheck(remark, location) {
      let name = localStorage.getItem("staffName") || "";
      if (!name.trim()) {
        name = prompt("Enter your name:");
        if (!name) return;  // Cancel if empty
        name = name.trim();
        if (!name) return;  // Cancel if empty after trim
        localStorage.setItem("staffName", name);
      }
      staffNameDisplay.textContent = `👤 ${name}`;

      const now = new Date();

      // Format current time in Kuala Lumpur timezone as ISO string without timezone offset
      const currentTime = now.toLocaleString('en-GB', {
        timeZone: 'Asia/Kuala_Lumpur',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });

      // Get current date string YYYY-MM-DD in Kuala Lumpur timezone for date comparison
      const todayDateStr = new Date(now.toLocaleString('en-CA', { timeZone: 'Asia/Kuala_Lumpur' })).toISOString().slice(0, 10);

      // Retrieve last action type and date from localStorage
      const lastAction = localStorage.getItem("lastActionType");
      const lastActionDate = localStorage.getItem("lastActionDate");

      // Determine if action is Check-In or Check-Out
      let action;
      if (lastAction === "Check-In" && lastActionDate === todayDateStr) {
        // If last action today was Check-In, then now Check-Out
        action = "Check-Out";
        // Clear last action as day’s attendance complete
        localStorage.removeItem("lastActionType");
        localStorage.removeItem("lastActionDate");
      } else {
        // Otherwise this is Check-In
        action = "Check-In";
        localStorage.setItem("lastActionType", action);
        localStorage.setItem("lastActionDate", todayDateStr);
      }

      sendAttendance(name, action, remark, location, currentTime);

      // Reload attendance history shortly after sending
      setTimeout(loadHistoryFromSheet, 1000);
    }

    // Send attendance data to Google Form via POST
    function sendAttendance(name, action, remark, location, time) {
      // IMPORTANT: Replace entry.xxxxxxxx with your actual Google Form field IDs
      const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSdGDioMohaZRkJrgxoseooVhyXTopysgEBE3QJB6cJMRzi2Wg/formResponse";
      const formData = new FormData();
      formData.append("entry.2140323296", name);     // Name field
      formData.append("entry.668867521", action);    // Action field (Check-In/Out)
      formData.append("entry.1111111111", remark);   // Remark field (GPS/No GPS)
      formData.append("entry.2222222222", location); // Location field (lat,lng or No Location)
      formData.append("entry.3333333333", time);     // Timestamp field

      fetch(formUrl, { method: "POST", mode: "no-cors", body: formData })
        .then(() => {
          alert(`${action} successful at ${time}`);
        })
        .catch((error) => {
          alert(`Error sending attendance: ${error}`);
        });
    }

    // Populate month and year selectors with current month/year selected
    function populateMonthYearSelectors() {
      const monthSelect = document.getElementById("monthSelect");
      const yearSelect = document.getElementById("yearSelect");
      const now = new Date();

      // Populate months
      const months = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];
      months.forEach((m, i) => {
        const opt = document.createElement("option");
        opt.value = i + 1; // months 1-12
        opt.textContent = m;
        monthSelect.appendChild(opt);
      });

      // Populate years (from 2020 to current year + 2)
      const startYear = 2020;
      const endYear = now.getFullYear() + 2;
      for (let y = startYear; y <= endYear; y++) {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        yearSelect.appendChild(opt);
      }

      // Set current month and year selected
      monthSelect.value = now.getMonth() + 1;
      yearSelect.value = now.getFullYear();
    }

    // Load attendance history from Google Sheets JSON endpoint
    // This URL should point to your published Google Sheet JSON (from your sheet or Apps Script)
    async function loadHistoryFromSheet() {
      const month = document.getElementById("monthSelect").value;
      const year = document.getElementById("yearSelect").value;

      const historyBody = document.getElementById("historyBody");
      historyBody.innerHTML = "<tr><td colspan='8'>Loading...</td></tr>";

      // Replace this URL with your published Google Sheet JSON or Google Apps Script web app URL
      const sheetJsonUrl = "https://script.google.com/macros/s/AKfycbyKY2m5VkRWW2O_NHlD3iDzLbq9GOiWeSLYPvIQMrjg5BZHo_qGVtrsKWzFJMsupJg4/exec";

      try {
        const response = await fetch(sheetJsonUrl);
        if (!response.ok) throw new Error("Failed to fetch attendance data");

        const data = await response.json();

        // data assumed to be array of records with keys:
        // date, name, checkIn, checkOut, totalHours, minutes, remark, location

        // Filter records by selected year and month (date assumed in ISO YYYY-MM-DD)
        const filtered = data.filter(rec => {
          if (!rec.date) return false;
          const [y, m] = rec.date.split("-");
          return (y == year && m == month.toString().padStart(2, '0'));
        });

        if (filtered.length === 0) {
          historyBody.innerHTML = "<tr><td colspan='8'>No records for selected month/year.</td></tr>";
          return;
        }

        // Sort records by date ascending
        filtered.sort((a, b) => a.date.localeCompare(b.date));

        // Build table rows
        historyBody.innerHTML = filtered.map(rec => `
          <tr>
            <td>${rec.date || ""}</td>
            <td>${rec.name || ""}</td>
            <td>${rec.checkIn || ""}</td>
            <td>${rec.checkOut || ""}</td>
            <td>${rec.totalHours || ""}</td>
            <td>${rec.minutes || ""}</td>
            <td>${rec.remark || ""}</td>
            <td>${rec.location || ""}</td>
          </tr>
        `).join("");
      } catch (err) {
        historyBody.innerHTML = `<tr><td colspan='8'>Error loading data: ${err.message}</td></tr>`;
      }
    }

    populateMonthYearSelectors();
    loadHistoryFromSheet();

  </script>
</body>
</html>

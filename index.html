<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance Check-In</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      padding: 20px;
      text-align: center;
    }
    h2 {
      color: #333;
      font-size: 24px;
    }
    .container {
      margin-top: 30px;
    }
    #datetime {
      font-size: 18px;
      margin-bottom: 20px;
      color: #555;
    }
    #staffNameDisplay {
      font-size: 20px;
      margin-bottom: 30px;
      color: #333;
    }
    button {
      padding: 12px 24px;
      font-size: 18px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    table {
      width: 100%;
      max-width: 800px;
      margin: auto;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
    }
    th {
      background-color: #f2f2f2;
    }
    select {
      padding: 6px;
      margin: 10px;
      font-size: 16px;
    }
    @media (max-width: 600px) {
      button, select {
        width: 100%;
        font-size: 16px;
      }
      #staffNameDisplay {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <h2>Attendance Check-In</h2>
  <div id="datetime"></div>
  <div id="staffNameDisplay"></div>

  <div class="container">
    <button onclick="checkLocation()">Check In / Check Out</button>

    <h3>ðŸ“œ Attendance History</h3>
    <div>
      <label>Month:</label>
      <select id="monthSelect" onchange="loadHistoryFromSheet()"></select>
      <label>Year:</label>
      <select id="yearSelect" onchange="loadHistoryFromSheet()"></select>
    </div>

    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Name</th>
          <th>Check-In</th>
          <th>Check-Out</th>
          <th>Total Hours</th>
          <th>Minutes</th>
          <th>Remark</th>
          <th>Location</th>
        </tr>
      </thead>
      <tbody id="historyBody">
        <!-- Attendance records will be inserted here -->
      </tbody>
    </table>
  </div>

  <script>
    // Constants
    const officeLat = 3.1925444;
    const officeLng = 101.6110718;
    const maxDistanceMeters = 500;

    // Date and Time Display (fixed to Asia/Kuala_Lumpur timezone)
    function updateDateTime() {
      const now = new Date();
      const optionsDate = { 
        timeZone: 'Asia/Kuala_Lumpur',
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
      };
      const optionsTime = { 
        timeZone: 'Asia/Kuala_Lumpur',
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
      };

      const dateStr = now.toLocaleDateString(undefined, optionsDate);
      const timeStr = now.toLocaleTimeString(undefined, optionsTime);

      document.getElementById("datetime").innerHTML = `${dateStr} | ${timeStr}`;
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    // Staff Name
    const staffNameDisplay = document.getElementById("staffNameDisplay");
    const storedName = localStorage.getItem("staffName");
    staffNameDisplay.textContent = storedName ? `ðŸ‘¤ ${storedName}` : 'ðŸ‘¤ No name saved yet';

    // GPS Distance Calculation
    function distanceBetween(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    // Location Check
    function checkLocation() {
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        const distance = distanceBetween(latitude, longitude, officeLat, officeLng);
        if (distance <= maxDistanceMeters) {
          proceedCheck("Used GPS", `${latitude}, ${longitude}`);
        } else {
          if (confirm("âŒ You are not in office area!\n\nProceed anyway?")) {
            proceedCheck("No GPS", "No Location");
          }
        }
      }, () => {
        if (confirm("âŒ Cannot get location. Proceed anyway?")) {
          proceedCheck("No GPS", "No Location");
        }
      });
    }

    // Check In or Out
    function proceedCheck(remark, location) {
      let name = localStorage.getItem("staffName") || prompt("Enter your name:");
      if (!name) return;
      localStorage.setItem("staffName", name);
      staffNameDisplay.textContent = `ðŸ‘¤ ${name}`;

      const today = new Date();
      const currentTime = today.toLocaleString('en-GB', {
        timeZone: 'Asia/Kuala_Lumpur',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });

      const lastAction = localStorage.getItem("lastActionDate");
      const action = (lastAction === today.toISOString().slice(0, 10)) ? "Check-Out" : "Check-In";
      if (action === "Check-In") {
        localStorage.setItem("lastActionDate", today.toISOString().slice(0, 10));
      } else {
        localStorage.removeItem("lastActionDate");
      }

      sendAttendance(name, action, remark, location, currentTime);
    }

    // Send to Google Form
    function sendAttendance(name, action, remark, location, checkInTime) {
      const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSdGDioMohaZRkJrgxoseooVhyXTopysgEBE3QJB6cJMRzi2Wg/formResponse";
      const formData = new FormData();
      formData.append("entry.2140323296", name);
      formData.append("entry.668867521", action);
      formData.append("entry.1234567890", remark);
      formData.append("entry.9876543210", location);
      formData.append("entry.1234567891", checkInTime);

      fetch(formUrl, { method: "POST", mode: "no-cors", body: formData })
        .then(() => alert(`âœ… ${action} successful for ${name} at ${checkInTime}`))
        .catch(() => alert("âŒ Failed to send attendance!"));
    }

    // Format HH:MM
    function formatTime(timeString) {
      if (!timeString) return "";
      const [hour, minute] = timeString.split(":");
      return `${hour.padStart(2, '0')}:${minute.padStart(2, '0')}`;
    }

    // Load Attendance History
    function loadHistoryFromSheet() {
      const name = localStorage.getItem("staffName");
      if (!name) {
        alert("â— Please check in at least once to save your name.");
        return;
      }

      const normName = name.trim().toLowerCase();
      const month = parseInt(document.getElementById("monthSelect").value);
      const year = parseInt(document.getElementById("yearSelect").value);

      fetch('https://script.google.com/macros/s/AKfycbxBjTno627hPi6F60Uzma_ba6DGxnYc6NEqGCjrr10IBr9-LxhhR_qimF8ay4CPEsRc/exec')
        .then(res => res.json())
        .then(data => {
          const tbody = document.getElementById("historyBody");
          tbody.innerHTML = "";

          const filtered = data.filter(r => {
            const recName = (r["Name"] || "").trim().toLowerCase();
            const recDate = r["Date"];
            if (!recDate || !recDate.includes("/")) return false;
            const [d, m, y] = recDate.split("/").map(x => parseInt(x));
            if (recName !== normName) return false;
            if (m !== month || y !== year) return false;
            return true;
          });

          // Aggregate by date
          const summary = {};
          filtered.forEach(r => {
            const date = r.Date;
            if (!summary[date]) summary[date] = { CheckIn: "", CheckOut: "", TotalH: 0, TotalM: 0, Remark: "", Location: "" };
            if (r.Action === "Check-In" && !summary[date].CheckIn) summary[date].CheckIn = r.Time;
            if (r.Action === "Check-Out" && !summary[date].CheckOut) summary[date].CheckOut = r.Time;
            summary[date].Remark = r.Remark || summary[date].Remark;
            summary[date].Location = r.Location || summary[date].Location;

            // Calculate total time if both check-in/out present
            if (summary[date].CheckIn && summary[date].CheckOut) {
              const tIn = new Date(`${date} ${summary[date].CheckIn}`);
              const tOut = new Date(`${date} ${summary[date].CheckOut}`);
              const diffMs = tOut - tIn;
              if (diffMs > 0) {
                const diffMins = Math.floor(diffMs / 60000);
                summary[date].TotalH = Math.floor(diffMins / 60);
                summary[date].TotalM = diffMins % 60;
              }
            }
          });

          Object.entries(summary).forEach(([date, val]) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${date}</td>
              <td>${name}</td>
              <td>${val.CheckIn}</td>
              <td>${val.CheckOut}</td>
              <td>${val.TotalH}</td>
              <td>${val.TotalM}</td>
              <td>${val.Remark}</td>
              <td>${val.Location}</td>
            `;
            tbody.appendChild(row);
          });
        })
        .catch(() => alert("Failed to load attendance history."));
    }

    // Populate month and year dropdowns
    function populateMonthYear() {
      const monthSelect = document.getElementById("monthSelect");
      const yearSelect = document.getElementById("yearSelect");

      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth() + 1;

      for (let m = 1; m <= 12; m++) {
        const option = document.createElement("option");
        option.value = m;
        option.text = m.toString().padStart(2, '0');
        monthSelect.appendChild(option);
      }
      monthSelect.value = currentMonth;

      for (let y = currentYear - 5; y <= currentYear + 1; y++) {
        const option = document.createElement("option");
        option.value = y;
        option.text = y.toString();
        yearSelect.appendChild(option);
      }
      yearSelect.value = currentYear;
    }

    populateMonthYear();
    loadHistoryFromSheet();
  </script>
</body>
</html>
